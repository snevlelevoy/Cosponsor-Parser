<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosponsor Formatting Tool</title>
    <style>
        /* Using system fonts as fallback for Avenir Next LT Pro */
        @font-face {
            font-family: 'Avenir Next LT Pro Demi';
            src: local('Avenir Next LT Pro Demi'), local('Avenir Next Demi'), local('Avenir Next');
            font-weight: 600;
            font-style: normal;
        }

        :root {
            --primary: #4a6cf7;
            --primary-dark: #3a5bd9;
            --text: #16325C;
            --text-light: #16325C;
            --text-lighter: #16325C;
            --border: #e2e8f0;
            --border-hover: #cbd5e0;
            --bg-light: #ffffff;
            --bg-section: #ffffff;
            --section-header-bg: #DBE2F4;
            --shadow: none;
            --radius: 0;
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            font-size: 16px;
            line-height: 1.6;
            color: var(--text);
            background-color: var(--bg-light);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        h1 {
            font-family: 'Avenir Next LT Pro Demi', 'Avenir Next', sans-serif;
            font-size: 2.25rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text);
            text-align: center;
            margin-bottom: 2rem;
        }

        .section {
            margin-bottom: 2rem;
            background-color: var(--bg-section);
            border: 1px solid var(--border);
        }

        .section-header {
            background-color: var(--section-header-bg);
            color: var(--text);
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .section-header:hover {
            background-color: #d0d9f0;
        }

        .section-header.non-collapsible {
            cursor: default;
        }

        .section-header.non-collapsible:hover {
            background-color: var(--section-header-bg);
        }

        .arrow {
            transition: transform 0.2s ease;
            font-size: 0.8rem;
        }

        .arrow.expanded {
            transform: rotate(90deg);
        }

        .section-content {
            padding: 1.5rem;
            display: block;
        }

        .section-content.collapsed {
            display: none;
        }

        .subsection {
            margin-bottom: 1.5rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 1rem;
            background-color: #fafafa;
        }

        .subsection:last-child {
            margin-bottom: 0;
        }

        .subsection-title {
            font-weight: bold;
            margin-bottom: 0.75rem;
            color: var(--text);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: bold;
            color: var(--text);
        }

        select, textarea, button {
            font-family: 'Times New Roman', serif;
            font-size: 16px;
        }

        select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            background-color: #F1F4FF;
            color: var(--text);
            border-radius: var(--radius);
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            resize: vertical;
            font-family: 'Times New Roman', serif;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: var(--radius);
            font-weight: bold;
            transition: var(--transition);
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        button:active {
            transform: translateY(1px);
        }

        .examples-toggle {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .examples-toggle:hover {
            color: var(--primary-dark);
        }

        .examples {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9ff;
            border: 1px solid var(--border);
            display: none;
        }

        .examples.show {
            display: block;
        }

        .example-section {
            margin-bottom: 1rem;
        }

        .example-section:last-child {
            margin-bottom: 0;
        }

        .example-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .example-text {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 0.5rem;
            border-radius: 3px;
            font-size: 14px;
        }

        .output-container {
            position: relative;
            margin-top: 1rem;
        }

        .output-area {
            min-height: 120px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            background-color: #f8f9ff;
            border-radius: var(--radius);
            white-space: pre-wrap;
            font-family: 'Times New Roman', serif;
        }

        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.25rem 0.5rem;
            font-size: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .copy-button:hover {
            background-color: var(--primary-dark);
        }

        .copy-button.copied {
            background-color: #10b981;
        }

        .ambiguous-names {
            margin: 1rem 0;
            padding: 1rem;
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: var(--radius);
            display: none;
        }

        .ambiguous-names.show {
            display: block;
        }

        .ambiguous-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #856404;
        }

        .name-option {
            margin: 0.5rem 0;
        }

        .name-option label {
            font-weight: normal;
            margin-left: 0.5rem;
        }

        .footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: var(--text-lighter);
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.75rem;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Counter.dev analytics -->
    <script src="https://cdn.counter.dev/script.js" data-id="91fcf8e8-fa60-40bf-851e-75466ee260b0" data-utcoffset="-4"></script>
</head>
<body>
    <div class="container">
        <h1>Cosponsor Formatting Tool</h1>

        <!-- Instructions Section -->
        <div class="section" id="instructions">
            <div class="section-header" onclick="toggleSection('instructions')">
                <span>INSTRUCTIONS</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="section-content collapsed">
                <p>This tool helps you format congressional cosponsor lists from Congress.gov or Dear Colleague letters into properly formatted output for memos.</p>
                
                <h3 style="margin: 1rem 0 0.5rem 0; font-weight: bold;">How to use:</h3>
                <ul>
                    <li><strong>Settings:</strong> Configure formatting preferences including italics, highlights, and duplicate name handling</li>
                    <li><strong>Input Mode:</strong> Choose between Congress.gov format or Dear Colleague format</li>
                    <li><strong>Input:</strong> Paste your cosponsor list in the text area</li>
                    <li><strong>Format:</strong> Click "Format Names" to process the list</li>
                    <li><strong>Output:</strong> Copy the formatted result using the copy button</li>
                </ul>

                <h3 style="margin: 1rem 0 0.5rem 0; font-weight: bold;">Settings explained:</h3>
                <ul>
                    <li><strong>Italics:</strong> Choose which party's names to display in italics</li>
                    <li><strong>Highlights:</strong> Select party and state to highlight specific members</li>
                    <li><strong>Duplicate Names:</strong> Control how to format members with the same last name</li>
                    <li><strong>Input Mode:</strong> Select the format of your input data</li>
                </ul>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section" id="settings">
            <div class="section-header" onclick="toggleSection('settings')">
                <span>SETTINGS</span>
                <span class="arrow">â–¶</span>
            </div>
            <div class="section-content collapsed">
                <div class="settings-grid">
                    <div class="subsection">
                        <div class="subsection-title">Input Preferences</div>
                        <div class="form-group">
                            <label for="input-mode">Select input format:</label>
                            <select id="input-mode">
                                <option value="congress-gov">Congress.gov format</option>
                                <option value="dear-colleague">List of last names</option>
                            </select>
                        </div>
                        <div class="examples-toggle" onclick="toggleExamples()">
                            Not sure? Click here to see examples
                        </div>
                    </div>

                    <div class="subsection">
                        <div class="subsection-title">Formatting Rules</div>
                        <div class="form-group">
                            <label for="duplicate-format">Format for duplicate last names:</label>
                            <select id="duplicate-format">
                                <option value="last-only">Last name only</option>
                                <option value="first-initial">First initial + last name</option>
                                <option value="full-name">Full name</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sort-order">Sort order:</label>
                            <select id="sort-order">
                                <option value="alphabetical">Alphabetical by last name</option>
                                <option value="input-order">Input order</option>
                            </select>
                        </div>
                    </div>

                    <div class="subsection">
                        <div class="subsection-title">Visual Styling</div>
                        <div class="form-group">
                            <label for="italics-select">Italicize names by party:</label>
                            <select id="italics-select">
                                <option value="none">No Party Filter</option>
                                <option value="democrats">Democrats</option>
                                <option value="republicans">Republicans</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="highlight-party">Highlight by party:</label>
                            <select id="highlight-party">
                                <option value="none">No Party Filter</option>
                                <option value="democrats">Democrats</option>
                                <option value="republicans">Republicans</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="highlight-state">Highlight by state:</label>
                            <select id="highlight-state">
                                <option value="none">None</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="examples" id="examples">
                    <div class="example-section">
                        <div class="example-title">Congress.gov Format:</div>
                        <div class="example-text">Rep. Smith, John [D-CA-12]* 01/15/2024
Rep. Johnson, Mary [R-TX-8] 01/16/2024
Rep. Williams, Robert [D-NY-15]* 01/17/2024</div>
                    </div>
                    <div class="example-section">
                        <div class="example-title">List of last names:</div>
                        <div class="example-text">Smith, Johnson, Williams, Davis, Brown, Wilson, Moore, Taylor, Anderson, Thomas</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input/Output Section -->
        <div class="section" id="input-output">
            <div class="section-header non-collapsible">
                <span>COSPONSOR LIST & FORMATTED OUTPUT</span>
            </div>
            <div class="section-content">
                <form id="format-form">
                    <div class="form-group">
                        <label for="input-text">Paste your cosponsor list here:</label>
                        <textarea id="input-text" placeholder="Rep. LastName, FirstName [X-XX]..."></textarea>
                    </div>
                    
                    <button type="submit">Format Names</button>
                </form>

                <div class="ambiguous-names" id="ambiguous-names">
                    <div class="ambiguous-title">Multiple matches found. Please select the correct representatives:</div>
                    <div id="ambiguous-options"></div>
                    <button type="button" onclick="resolveAmbiguous()">Continue with Selected</button>
                </div>

                <div class="output-container">
                    <div class="output-area" id="output-area">Your formatted list will appear here</div>
                    <button class="copy-button" id="copy-button" onclick="copyOutput()">Copy</button>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Created by <a href="https://www.linkedin.com/in/sophia-nevle-levoy" target="_blank">Sophie Nevle Levoy</a>, please message me with feedback!</p>
        </footer>
    </div>

    <script>
        // Global variables
        let congressMembers = [];
        let ambiguousMatches = {};
        let currentProcessedInput = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Populate state dropdown first so settings can be properly restored
            populateStateDropdown();
            loadCongressMembers();
            loadSettings();
            setupEventListeners();
        });

        // Set up event listeners for settings
        function setupEventListeners() {
            // Add event listeners for all settings dropdowns to save changes
            document.getElementById('italics-select').addEventListener('change', saveSettings);
            document.getElementById('highlight-party').addEventListener('change', saveSettings);
            document.getElementById('highlight-state').addEventListener('change', saveSettings);
            document.getElementById('duplicate-format').addEventListener('change', saveSettings);
            document.getElementById('input-mode').addEventListener('change', saveSettings);
            document.getElementById('sort-order').addEventListener('change', saveSettings);
        }

        // Load congressional members data from GitHub repository
        async function loadCongressMembers() {
            try {
                console.log('Loading congressional members from GitHub repository...');
                const response = await fetch('https://raw.githubusercontent.com/snevlelevoy/congressional-members-tracker/main/data/congressional_members_latest.json?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const rawData = await response.json();
                
                // Transform the data to match our expected format
                // The new JSON structure has a 'members' array wrapper
                const membersArray = rawData.members || rawData;
                
                congressMembers = membersArray
                    .filter(member => member.chamber === 'House' || member.chamber === 'Senate') // Include both House and Senate
                    .map(member => ({
                        firstName: member.first_name,
                        lastName: member.last_name,
                        party: member.party === 'Democratic' ? 'D' : member.party === 'Republican' ? 'R' : member.party.charAt(0),
                        state: getStateAbbreviation(member.state),
                        district: member.district ? member.district.toString() : '',
                        status: 'active',
                        id: member.id || `${member.first_name}-${member.last_name}`,
                        chamber: member.chamber,
                        fullName: `${member.first_name} ${member.last_name}`
                    }));
                
                console.log(`Successfully loaded ${congressMembers.length} congressional members from GitHub repository`);
                
            } catch (error) {
                console.error('Error loading congressional members from GitHub:', error);
                console.log('Falling back to sample data...');
                
                // Fallback to sample data if GitHub fetch fails
                congressMembers = [
                    { firstName: "Andy", lastName: "Ogles", party: "R", state: "TN", district: "5", status: "active" },
                    { firstName: "Bob", lastName: "Filner", party: "D", state: "CA", district: "51", status: "active" },
                    { firstName: "John", lastName: "Smith", party: "D", state: "CA", district: "12", status: "active" },
                    { firstName: "William", lastName: "Smith", party: "R", state: "NC", district: "5", status: "active" },
                    { firstName: "Mary", lastName: "Johnson", party: "R", state: "TX", district: "8", status: "active" },
                    { firstName: "Elizabeth", lastName: "Johnson", party: "D", state: "OR", district: "1", status: "active" }
                ];
                
                console.log('Using fallback sample data');
            }
        }
        
        // Helper function to convert state names to abbreviations
        function getStateAbbreviation(stateName) {
            const stateMap = {
                'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
                'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
                'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
                'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
                'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
                'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
                'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
                'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
                'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
                'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY',
                'District of Columbia': 'DC', 'Puerto Rico': 'PR'
            };
            return stateMap[stateName] || stateName;
        }

        // Populate state dropdown with all US states and territories
        function populateStateDropdown() {
            const stateSelect = document.getElementById('highlight-state');
            
            // Complete list of US states and territories with abbreviations
            const statesAndTerritories = [
                { name: 'Alabama', abbr: 'AL' },
                { name: 'Alaska', abbr: 'AK' },
                { name: 'Arizona', abbr: 'AZ' },
                { name: 'Arkansas', abbr: 'AR' },
                { name: 'American Samoa', abbr: 'AS' },
                { name: 'California', abbr: 'CA' },
                { name: 'Colorado', abbr: 'CO' },
                { name: 'Connecticut', abbr: 'CT' },
                { name: 'Delaware', abbr: 'DE' },
                { name: 'District of Columbia', abbr: 'DC' },
                { name: 'Florida', abbr: 'FL' },
                { name: 'Georgia', abbr: 'GA' },
                { name: 'Guam', abbr: 'GU' },
                { name: 'Hawaii', abbr: 'HI' },
                { name: 'Idaho', abbr: 'ID' },
                { name: 'Illinois', abbr: 'IL' },
                { name: 'Indiana', abbr: 'IN' },
                { name: 'Iowa', abbr: 'IA' },
                { name: 'Kansas', abbr: 'KS' },
                { name: 'Kentucky', abbr: 'KY' },
                { name: 'Louisiana', abbr: 'LA' },
                { name: 'Maine', abbr: 'ME' },
                { name: 'Maryland', abbr: 'MD' },
                { name: 'Massachusetts', abbr: 'MA' },
                { name: 'Michigan', abbr: 'MI' },
                { name: 'Minnesota', abbr: 'MN' },
                { name: 'Mississippi', abbr: 'MS' },
                { name: 'Missouri', abbr: 'MO' },
                { name: 'Montana', abbr: 'MT' },
                { name: 'Nebraska', abbr: 'NE' },
                { name: 'Nevada', abbr: 'NV' },
                { name: 'New Hampshire', abbr: 'NH' },
                { name: 'New Jersey', abbr: 'NJ' },
                { name: 'New Mexico', abbr: 'NM' },
                { name: 'New York', abbr: 'NY' },
                { name: 'North Carolina', abbr: 'NC' },
                { name: 'North Dakota', abbr: 'ND' },
                { name: 'Northern Mariana Islands', abbr: 'MP' },
                { name: 'Ohio', abbr: 'OH' },
                { name: 'Oklahoma', abbr: 'OK' },
                { name: 'Oregon', abbr: 'OR' },
                { name: 'Pennsylvania', abbr: 'PA' },
                { name: 'Puerto Rico', abbr: 'PR' },
                { name: 'Rhode Island', abbr: 'RI' },
                { name: 'South Carolina', abbr: 'SC' },
                { name: 'South Dakota', abbr: 'SD' },
                { name: 'Tennessee', abbr: 'TN' },
                { name: 'Texas', abbr: 'TX' },
                { name: 'Trust Territories', abbr: 'TT' },
                { name: 'Utah', abbr: 'UT' },
                { name: 'Vermont', abbr: 'VT' },
                { name: 'Virginia', abbr: 'VA' },
                { name: 'Virgin Islands', abbr: 'VI' },
                { name: 'Washington', abbr: 'WA' },
                { name: 'West Virginia', abbr: 'WV' },
                { name: 'Wisconsin', abbr: 'WI' },
                { name: 'Wyoming', abbr: 'WY' }
            ];
            
            stateSelect.innerHTML = '<option value="none">None</option>';
            
            statesAndTerritories.forEach(state => {
                const option = document.createElement('option');
                option.value = state.abbr.toLowerCase();
                option.textContent = `${state.name} (${state.abbr})`;
                stateSelect.appendChild(option);
            });
            
            console.log('State dropdown populated with options:', Array.from(stateSelect.options).map(opt => ({value: opt.value, text: opt.textContent})));
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('format-form').addEventListener('submit', function(e) {
                e.preventDefault();
                processInput();
            });

            const settingsElements = ['italics-select', 'highlight-party', 'highlight-state', 'duplicate-format', 'input-mode'];
            settingsElements.forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    saveSettings();
                    if (currentProcessedInput.length > 0) {
                        updateFormattedOutput();
                    }
                });
            });

            document.getElementById('input-mode').addEventListener('change', function() {
                const textarea = document.getElementById('input-text');
                if (this.value === 'congress-gov') {
                    textarea.placeholder = 'Rep. LastName, FirstName [X-XX]...';
                } else {
                    textarea.placeholder = 'LastName, LastName, LastName...';
                }
            });
        }

        // Toggle section visibility
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const content = section.querySelector('.section-content');
            const arrow = section.querySelector('.arrow');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                arrow.classList.add('expanded');
            } else {
                content.classList.add('collapsed');
                arrow.classList.remove('expanded');
            }
        }

        // Toggle examples visibility
        function toggleExamples() {
            const examples = document.getElementById('examples');
            examples.classList.toggle('show');
        }

        // Save settings to localStorage
        function saveSettings() {
            const settings = {
                italics: document.getElementById('italics-select').value,
                highlightParty: document.getElementById('highlight-party').value,
                highlightState: document.getElementById('highlight-state').value,
                duplicateFormat: document.getElementById('duplicate-format').value,
                inputMode: document.getElementById('input-mode').value,
                sortOrder: document.getElementById('sort-order').value
            };
            console.log('Saving settings:', settings);
            localStorage.setItem('cosponsorsettings', JSON.stringify(settings));
        }

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('cosponsorsettings');
            console.log('Loading settings from localStorage:', saved);
            if (saved) {
                const settings = JSON.parse(saved);
                console.log('Parsed settings:', settings);
                document.getElementById('italics-select').value = settings.italics || 'none';
                document.getElementById('highlight-party').value = settings.highlightParty || 'none';
                document.getElementById('highlight-state').value = settings.highlightState || 'none';
                document.getElementById('duplicate-format').value = settings.duplicateFormat || 'last-only';
                document.getElementById('input-mode').value = settings.inputMode || 'congress-gov';
                document.getElementById('sort-order').value = settings.sortOrder || 'alphabetical';
                
                console.log('State dropdown value after setting:', document.getElementById('highlight-state').value);
                
                const textarea = document.getElementById('input-text');
                if (settings.inputMode === 'dear-colleague') {
                    textarea.placeholder = 'LastName, LastName, LastName...';
                }
            } else {
                console.log('No saved settings found');
            }
        }

        // Process input based on selected mode
        function processInput() {
            const inputText = document.getElementById('input-text').value.trim();
            const inputMode = document.getElementById('input-mode').value;
            
            if (!inputText) {
                alert('Please enter a cosponsor list');
                return;
            }

            if (inputMode === 'congress-gov') {
                processCongressGovInput(inputText);
            } else {
                processLastNamesInput(inputText);
            }
        }

        // Process Congress.gov format input
        function processCongressGovInput(inputText) {
            const lines = inputText.split('\n').filter(line => line.trim());
            const processed = [];
            
            lines.forEach(line => {
                const match = line.match(/Rep\.\s+([^,]+),\s+([^\[]+)\s*\[([DR])-([A-Z]{2})-?(\d*)\]/);
                if (match) {
                    const [, lastName, firstName, party, state, district] = match;
                    const member = {
                        firstName: firstName.trim(),
                        lastName: lastName.trim(),
                        party: party,
                        state: state,
                        district: district || '',
                        source: 'congress-gov'
                    };
                    processed.push(member);
                }
            });
            
            currentProcessedInput = processed;
            updateFormattedOutput();
        }

        // Process Dear Colleague format (last names only)
        function processLastNamesInput(inputText) {
            const lastNames = inputText.split(',').map(name => name.trim()).filter(name => name);
            const processed = [];
            ambiguousMatches = {};
            
            lastNames.forEach((lastName, index) => {
                const matches = congressMembers.filter(member => 
                    member.lastName.toLowerCase() === lastName.toLowerCase() && 
                    member.status === 'active'
                );
                
                if (matches.length === 1) {
                    processed.push(matches[0]);
                } else if (matches.length > 1) {
                    // Store ambiguous matches for user selection
                    ambiguousMatches[index] = {
                        lastName: lastName,
                        matches: matches
                    };
                    // Add placeholder entry that will be replaced when user selects
                    processed.push({
                        firstName: '',
                        lastName: lastName,
                        party: '',
                        state: '',
                        district: '',
                        source: 'ambiguous',
                        originalIndex: index
                    });
                } else {
                    processed.push({
                        firstName: '',
                        lastName: lastName,
                        party: '',
                        state: '',
                        district: '',
                        source: 'unknown'
                    });
                }
            });
            
            if (Object.keys(ambiguousMatches).length > 0) {
                showAmbiguousNames();
                currentProcessedInput = processed;
            } else {
                currentProcessedInput = processed;
                updateFormattedOutput();
            }
        }

        // Show ambiguous names selection UI
        function showAmbiguousNames() {
            const container = document.getElementById('ambiguous-names');
            const optionsDiv = document.getElementById('ambiguous-options');
            
            optionsDiv.innerHTML = '';
            
            Object.entries(ambiguousMatches).forEach(([index, data]) => {
                const nameDiv = document.createElement('div');
                nameDiv.innerHTML = `<strong>${data.lastName}:</strong>`;
                
                data.matches.forEach((match, matchIndex) => {
                    const option = document.createElement('div');
                    option.className = 'name-option';
                    option.innerHTML = `
                        <input type="radio" name="ambiguous-${index}" value="${matchIndex}" id="amb-${index}-${matchIndex}">
                        <label for="amb-${index}-${matchIndex}">${match.firstName} ${match.lastName} [${match.party}-${match.state}-${match.district}]</label>
                    `;
                    nameDiv.appendChild(option);
                });
                
                optionsDiv.appendChild(nameDiv);
            });
            
            container.classList.add('show');
        }

        // Resolve ambiguous name selections
        function resolveAmbiguous() {
            Object.entries(ambiguousMatches).forEach(([index, data]) => {
                const selected = document.querySelector(`input[name="ambiguous-${index}"]:checked`);
                if (selected) {
                    const matchIndex = parseInt(selected.value);
                    const selectedMember = data.matches[matchIndex];
                    
                    // Find and replace the placeholder entry
                    for (let i = 0; i < currentProcessedInput.length; i++) {
                        if (currentProcessedInput[i].source === 'ambiguous' && 
                            currentProcessedInput[i].originalIndex == index) {
                            currentProcessedInput[i] = selectedMember;
                            console.log(`Replaced ambiguous entry at index ${i} with:`, selectedMember);
                            break;
                        }
                    }
                }
            });
            
            document.getElementById('ambiguous-names').classList.remove('show');
            ambiguousMatches = {};
            console.log('Current processed input after resolution:', currentProcessedInput);
            updateFormattedOutput();
        }

        // Update formatted output based on current settings
        function updateFormattedOutput() {
            if (currentProcessedInput.length === 0) return;
            
            const italicsMode = document.getElementById('italics-select').value;
            const highlightParty = document.getElementById('highlight-party').value;
            const highlightState = document.getElementById('highlight-state').value;
            const duplicateFormat = document.getElementById('duplicate-format').value;
            const sortOrder = document.getElementById('sort-order').value;
            
            // Sort members based on user preference
            let sortedMembers;
            if (sortOrder === 'alphabetical') {
                sortedMembers = [...currentProcessedInput].sort((a, b) => {
                    return a.lastName.toLowerCase().localeCompare(b.lastName.toLowerCase());
                });
            } else {
                // Keep input order
                sortedMembers = [...currentProcessedInput];
            }
            
            // Separate Representatives and Senators
            const representatives = [];
            const senators = [];
            
            // Count Democrats and Republicans
            let democratCount = 0;
            let republicanCount = 0;
            
            sortedMembers.forEach(member => {
                // Count party affiliations
                if (member.party === 'D') democratCount++;
                else if (member.party === 'R') republicanCount++;
                
                // Format the name
                let name = formatName(member, duplicateFormat);
                
                // Apply italics based on party selection
                if ((italicsMode === 'democrats' && member.party === 'D') ||
                    (italicsMode === 'republicans' && member.party === 'R')) {
                    name = `<em>${name}</em>`;
                }
                
                // Apply highlighting based on party and/or state selection
                let shouldHighlight = false;
                
                // Only highlight if specific criteria are met
                if (highlightParty !== 'none' || highlightState !== 'none') {
                    let partyMatch = true; // Default to true if no party filter
                    let stateMatch = true; // Default to true if no state filter
                    
                    // Check party filter
                    if (highlightParty !== 'none') {
                        partyMatch = (highlightParty === 'democrats' && member.party === 'D') ||
                                   (highlightParty === 'republicans' && member.party === 'R');
                    }
                    
                    // Check state filter
                    if (highlightState !== 'none') {
                        stateMatch = (member.state && member.state.toLowerCase() === highlightState.toLowerCase());
                    }
                    
                    // Only highlight if ALL active filters match
                    shouldHighlight = partyMatch && stateMatch;
                    
                    // Debug logging
                    if (member.lastName === 'McCarthy') {
                        console.log(`McCarthy debug: party=${member.party}, state=${member.state}, highlightParty=${highlightParty}, highlightState=${highlightState}, partyMatch=${partyMatch}, stateMatch=${stateMatch}, shouldHighlight=${shouldHighlight}`);
                    }
                }
                
                if (shouldHighlight) {
                    name = `<mark>${name}</mark>`;
                }
                
                // Separate by chamber using the chamber field
                console.log(`${member.lastName}: chamber='${member.chamber}', party=${member.party}, state=${member.state}`);
                if (member.chamber === 'Senate') {
                    console.log(`  -> Adding ${member.lastName} to SENATORS`);
                    senators.push(name);
                } else {
                    console.log(`  -> Adding ${member.lastName} to REPRESENTATIVES`);
                    representatives.push(name);
                }
            });
            
            // Build the output with header and separated chambers
            let output = `<strong>Cosponsors (${democratCount}D, ${republicanCount}R):</strong> `;
            
            if (representatives.length > 0) {
                output += representatives.join(', ');
            }
            
            if (senators.length > 0) {
                if (representatives.length > 0) {
                    output += '<br><br>'; // Add paragraph break
                }
                output += senators.join(', ');
            }
            
            document.getElementById('output-area').innerHTML = output;
        }

        // Format individual name based on duplicate settings
        function formatName(member, duplicateFormat) {
            if (member.source === 'unknown') {
                return member.lastName;
            }
            
            const isDuplicate = isDuplicateName(member.lastName);
            
            if (!isDuplicate || duplicateFormat === 'last-only') {
                return member.lastName;
            } else if (duplicateFormat === 'first-initial') {
                return `${member.firstName.charAt(0)}. ${member.lastName}`;
            } else {
                return `${member.firstName} ${member.lastName}`;
            }
        }

        // Check if a last name appears multiple times in the congressional database
        function isDuplicateName(lastName) {
            // Check if there are multiple members with this last name in the congressional database
            const databaseMatches = congressMembers.filter(member => 
                member.lastName.toLowerCase() === lastName.toLowerCase() && 
                member.status === 'active'
            ).length;
            
            // Also check current input for multiple instances
            const inputMatches = currentProcessedInput.filter(member => 
                member.lastName.toLowerCase() === lastName.toLowerCase()
            ).length;
            
            // Consider it a duplicate if there are multiple in database OR multiple in current input
            return databaseMatches > 1 || inputMatches > 1;
        }

        // Copy output to clipboard
        async function copyOutput() {
            const outputArea = document.getElementById('output-area');
            const copyButton = document.getElementById('copy-button');
            
            try {
                const htmlContent = outputArea.innerHTML;
                const plainContent = outputArea.textContent;
                
                if (navigator.clipboard && window.ClipboardItem) {
                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const clipboardItem = new ClipboardItem({ 'text/html': blob });
                    await navigator.clipboard.write([clipboardItem]);
                } else {
                    await navigator.clipboard.writeText(plainContent);
                }
                
                copyButton.textContent = 'Copied!';
                copyButton.classList.add('copied');
                
                setTimeout(() => {
                    copyButton.textContent = 'Copy';
                    copyButton.classList.remove('copied');
                }, 2000);
                
            } catch (error) {
                console.error('Copy failed:', error);
                
                const range = document.createRange();
                range.selectNodeContents(outputArea);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                
                copyButton.textContent = 'Selected - Press Ctrl+C';
                setTimeout(() => {
                    copyButton.textContent = 'Copy';
                }, 3000);
            }
        }
    </script>
</body>
</html>
